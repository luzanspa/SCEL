<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SCEL - Sistema de Cadastro de Exames Laboratoriais</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    :root {
      --primary: #ffd700;
      --secondary: #ff8c00;
      --success: #28a745;
      --danger: #dc3545;
      --warning: #ffc107;
      --info: #17a2b8;
      --light: rgba(255, 255, 255, 0.98);
      --shadow: 0 8px 25px rgba(255, 215, 0, 0.4);
      --radius: 16px;
      --transition: all 0.3s ease;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .header {
      text-align: center;
      margin-bottom: 40px;
      color: white;
    }
    
    .header h1 {
      font-size: 2.5rem;
      font-weight: 800;
      margin-bottom: 10px;
      text-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    
    .card {
      background: var(--light);
      backdrop-filter: blur(20px);
      padding: 30px;
      margin-bottom: 30px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      transition: var(--transition);
    }

    .card:hover { transform: translateY(-2px); }
    
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
    }
    
    label {
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
      font-size: 0.9rem;
    }
    
    input, textarea, select {
      padding: 12px 16px;
      border: 2px solid #e8ecef;
      border-radius: 8px;
      font-size: 14px;
      transition: var(--transition);
      background: #fafbfc;
    }
    
    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: var(--primary);
      background: white;
      box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.15);
    }
    
    .btn {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: #333;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      text-transform: uppercase;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(255, 215, 0, 0.4);
    }
    
    .btn-danger {
      background: linear-gradient(135deg, var(--danger), #c82333);
      color: white;
    }
    
    .btn-success {
      background: linear-gradient(135deg, var(--success), #1e7e34);
      color: white;
    }
    
    .btn-small {
      padding: 6px 12px;
      font-size: 12px;
      min-width: 32px;
      height: 32px;
    }
    
    .search-bar {
      display: flex;
      gap: 15px;
      align-items: end;
    }
    
    .search-bar .form-group { flex: 1; }
    
    .table-container {
      background: var(--light);
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: var(--shadow);
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    th {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: #333;
      padding: 15px 12px;
      font-weight: 600;
      text-align: left;
      font-size: 0.85rem;
      text-transform: uppercase;
    }
    
    td {
      padding: 12px;
      border-bottom: 1px solid #f0f0f0;
      font-size: 0.85rem;
    }
    
    tr:hover {
      background: rgba(255, 215, 0, 0.1);
    }
    
    .actions {
      display: flex;
      gap: 5px;
    }

    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 10000;
    }

    .toast {
      background: white;
      border-radius: 8px;
      padding: 15px 20px;
      margin-bottom: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      border-left: 4px solid var(--success);
      min-width: 300px;
      animation: slideIn 0.3s ease;
    }

    .toast.error { border-left-color: var(--danger); }
    .toast.warning { border-left-color: var(--warning); }
    .toast.info { border-left-color: var(--info); }

    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    .exame-item {
      display: flex;
      align-items: center;
      padding: 4px 6px;
      margin: 1px 0;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid #e0e0e0;
      background: white;
      font-size: 11px;
    }

    .exame-item:hover {
      background: rgba(255, 215, 0, 0.1);
      border-color: var(--primary);
    }

    .exame-item.selecionado {
      background: linear-gradient(135deg, var(--success), #20c997);
      border-color: var(--success);
      color: white;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
      transform: translateY(-1px);
    }

    .exame-item.selecionado .exame-codigo {
      background: rgba(255, 255, 255, 0.9);
      color: var(--success);
      font-weight: 700;
    }

    .exame-item.selecionado::after {
      content: '‚úì';
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 16px;
      font-weight: bold;
      color: white;
    }

    .exame-item {
      position: relative;
    }

    .exame-codigo {
      background: var(--primary);
      color: #333;
      padding: 1px 4px;
      border-radius: 3px;
      font-size: 9px;
      font-weight: 600;
      margin-right: 5px;
      min-width: 35px;
      text-align: center;
    }

    .exame-nome {
      flex: 1;
      font-size: 10px;
    }

    .exame-tag {
      display: inline-block;
      background: var(--primary);
      color: #333;
      padding: 4px 8px;
      margin: 2px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }

    .exames-selecionados {
      padding: 10px;
      background: rgba(255, 215, 0, 0.1);
      border-radius: 6px;
      min-height: 40px;
    }

    .exames-modal-container {
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      padding: 10px;
      background: #fafafa;
    }

    .exames-modal-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr 1fr;
      gap: 12px;
    }

    .categoria-section {
      break-inside: avoid;
    }

    .categoria-exames {
      font-weight: 600;
      color: #666;
      font-size: 12px;
      margin: 8px 0 4px 0;
      text-transform: uppercase;
      border-bottom: 1px solid #eee;
      padding-bottom: 2px;
      grid-column: 1 / -1;
    }

    @media (max-width: 768px) {
      .exames-modal-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 1200px) and (min-width: 1025px) {
      .exames-modal-grid {
        grid-template-columns: 1fr 1fr 1fr;
      }
    }

    @media (max-width: 1024px) and (min-width: 769px) {
      .exames-modal-grid {
        grid-template-columns: 1fr 1fr;
      }
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 10000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
    }

    .modal-content {
      background: white;
      margin: 10% auto;
      padding: 30px;
      border-radius: var(--radius);
      width: 90%;
      max-width: 500px;
      box-shadow: var(--shadow);
    }

    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }

    .close:hover { color: #000; }

    .historico-cns {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
    }
    
    .historico-item {
      padding: 10px;
      border-bottom: 1px solid #f0f0f0;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .historico-item:hover {
      background: rgba(255, 215, 0, 0.1);
    }
    
    .historico-item:last-child {
      border-bottom: none;
    }
    
    .historico-nome {
      font-weight: 600;
      color: #333;
      font-size: 0.9rem;
    }
    
    .historico-detalhes {
      font-size: 0.8rem;
      color: #666;
      margin-top: 2px;
    }
    
    .form-group {
      position: relative;
    }

    @media (max-width: 768px) {
      .form-grid { grid-template-columns: 1fr; }
      .search-bar { flex-direction: column; }
      .header h1 { font-size: 2rem; }
      body { padding: 10px; }
    }
    
    /* Estilos para impress√£o */
    @media print {
      body { background: white !important; }
      .modal { position: static !important; background: white !important; }
      .modal-content { 
        max-width: 100% !important; 
        width: 100% !important; 
        height: auto !important; 
        margin: 0 !important; 
        padding: 15px !important;
        background: white !important;
        color: black !important;
        box-shadow: none !important;
        border-radius: 0 !important;
      }
      .close, .btn { display: none !important; }
      .chart-section, .metric-card, .dark-card {
        background: white !important;
        color: black !important;
        border: 1px solid #ddd !important;
        box-shadow: none !important;
        page-break-inside: avoid;
      }
      h1, h2, h3 { color: black !important; }
      .metric-card { 
        background: #f8f9fa !important;
        border: 2px solid #333 !important;
        margin-bottom: 10px !important;
      }
      #estatisticasContent {
        font-size: 11px !important;
        line-height: 1.3 !important;
      }
      .chart-section h3 {
        font-size: 12px !important;
        margin-bottom: 8px !important;
      }
      /* Ajustar grid para impress√£o */
      #estatisticasContent > div {
        grid-template-columns: 1fr 1fr !important;
        gap: 10px !important;
      }
      /* Compactar elementos */
      .metric-card div:first-child {
        font-size: 1.8rem !important;
      }
      .chart-section {
        padding: 10px !important;
        margin-bottom: 8px !important;
      }
    }
  </style>
</head>
<body>
  <div class="toast-container" id="toastContainer"></div>
  
  <div class="container">
    <div class="header">
      <h1>üè• SCEL</h1>
      <p>Sistema de Cadastro de Exames Laboratoriais</p>
      <div style="margin-top: 15px; display: flex; gap: 10px; justify-content: center;">
        <button class="btn btn-small" onclick="exportarExcel()">üìà Exportar Excel</button>
        <button class="btn btn-small" onclick="document.getElementById('importFile').click()">üìÅ Importar Excel</button>
        <button class="btn btn-small" onclick="abrirEstatisticas()">üìä Estat√≠sticas</button>
        <input type="file" id="importFile" accept=".xlsx,.xls" style="display: none;" onchange="importarExcel(event)">
      </div>
    </div>

    <div class="card">
      <h2 style="margin-bottom: 20px; color: #333;">üìã Cadastro de Paciente</h2>
      <form id="pacienteForm">
        <div class="form-grid">
          <div class="form-group">
            <label for="nome">Nome Completo *</label>
            <input type="text" id="nome" required>
          </div>
          <div class="form-group">
            <label for="cpf">CNS/CPF *</label>
            <input type="text" id="cpf" required maxlength="18" placeholder="CNS ou CPF">
            <div id="historicoCns" class="historico-cns"></div>
          </div>
          <div class="form-group">
            <label for="dataNascimento">Data de Nascimento *</label>
            <input type="date" id="dataNascimento" required>
          </div>
          <div class="form-group">
            <label for="telefone">Telefone</label>
            <input type="tel" id="telefone" placeholder="(00) 00000-0000">
          </div>
          <div class="form-group">
            <label for="genero">G√™nero *</label>
            <select id="genero" required onchange="toggleOutroGenero()">
              <option value="">Selecione...</option>
              <option value="masculino">Homem</option>
              <option value="feminino">Mulher</option>
              <option value="outro">Outro</option>
            </select>
          </div>
          <div class="form-group" id="outroGeneroDiv" style="display: none;">
            <label for="outroGenero">Especificar G√™nero</label>
            <input type="text" id="outroGenero" placeholder="Digite o g√™nero...">
          </div>
          <div class="form-group">
            <label for="laboratorio">Laborat√≥rio *</label>
            <select id="laboratorio" required>
              <option value="">Selecione...</option>
              <option value="apolo">Apolo</option>
              <option value="queiroz">Queiroz</option>
              <option value="sao_lourenco">S√£o Louren√ßo</option>
            </select>
          </div>
        </div>
        
        <div class="form-group" style="grid-column: 1 / -1;">
          <label for="endereco">Endere√ßo Completo *</label>
          <input type="text" id="endereco" placeholder="Rua, n√∫mero, bairro, cidade, CEP" required>
        </div>

        <div class="form-group">
          <label for="exames">Exames Solicitados *</label>
          <button type="button" class="btn" onclick="abrirModalExames()" style="width: 100%; margin-bottom: 10px;">
            üìã Selecionar Exames
          </button>
          <div class="exames-selecionados" id="examesSelecionados">
            <small style="color: #666;">Nenhum exame selecionado</small>
          </div>
        </div>

        <div style="margin-top: 20px;" id="botoesFormulario">
          <button type="submit" class="btn btn-success" id="btnCadastrar">üíæ Cadastrar</button>
          <div id="botoesEdicao" style="display: none; gap: 15px;">
            <button type="submit" class="btn btn-success">üíæ Salvar</button>
            <button type="button" class="btn" onclick="cancelarEdicao()">‚ùå Cancelar</button>
          </div>
        </div>
      </form>
    </div>

    <div class="card">
      <h2 style="margin-bottom: 15px; color: #333;">üîç Buscar Pacientes</h2>
      <div class="form-group">
        <label for="busca">Buscar em todos os campos</label>
        <input type="text" id="busca" placeholder="Digite qualquer informa√ß√£o do paciente..." oninput="buscarPacientes()">
      </div>
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th style="min-width: 90px;">Data Cadastro</th>
            <th>Nome</th>
            <th>CNS/CPF</th>
            <th style="min-width: 100px;">Data Nascimento</th>
            <th>Telefone</th>
            <th style="min-width: 80px;">G√™nero</th>
            <th>Laborat√≥rio</th>
            <th>Endere√ßo</th>
            <th>Exames</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="tabelaPacientes">
          <tr>
            <td colspan="6" style="text-align: center; color: #666; padding: 30px;">
              Nenhum paciente cadastrado
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Modal de Sele√ß√£o de Exames -->
  <div id="modalExames" class="modal">
    <div class="modal-content" style="max-width: 900px; width: 90%;">
      <span class="close" onclick="fecharModalExames()">&times;</span>
      <h2>üìã Selecionar Exames</h2>

      <div class="exames-modal-container">
        <div class="exames-modal-grid" id="examesModalGrid">
          <!-- Exames ser√£o carregados aqui -->
        </div>
      </div>
      <div style="display: flex; gap: 15px; margin-top: 20px; justify-content: center;">
        <button type="button" class="btn btn-success" onclick="confirmarExames()">‚úì Confirmar Sele√ß√£o</button>
        <button type="button" class="btn" onclick="fecharModalExames()">‚ùå Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Modal Dashboard -->
  <div id="modalEstatisticas" class="modal">
    <div class="modal-content" style="max-width: 100vw; width: 100vw; height: 100vh; max-height: 100vh; margin: 0; padding: 20px; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%); color: white; border: none; border-radius: 0; overflow-y: auto;">
      <div style="position: absolute; top: 15px; right: 25px; z-index: 1000; display: flex; gap: 10px;">
        <button class="btn btn-small" onclick="imprimirDashboard()" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3);">üñ®Ô∏è Imprimir</button>
        <span class="close" onclick="fecharEstatisticas()" style="color: white; font-size: 28px; cursor: pointer;">&times;</span>
      </div>
      <h1 style="text-align: center; margin-bottom: 25px; color: white; font-size: 1.6rem; font-weight: bold; text-transform: uppercase; letter-spacing: 2px;">üè• DASHBOARD ACOMPANHAMENTO SCEL</h1>
      <div id="estatisticasContent">
        <!-- Dashboard ser√° carregado aqui -->
      </div>
    </div>
  </div>

  <div id="modalEdicao" class="modal">
    <div class="modal-content">
      <span class="close" onclick="fecharModal()">&times;</span>
      <h2>‚úèÔ∏è Editar Paciente</h2>
      <form id="formEdicao">
        <div class="form-group">
          <label for="editNome">Nome Completo</label>
          <input type="text" id="editNome" required>
        </div>
        <div class="form-group">
          <label for="editTelefone">Telefone</label>
          <input type="tel" id="editTelefone">
        </div>
        <div class="form-group">
          <label for="editGenero">G√™nero</label>
          <select id="editGenero" onchange="toggleEditOutroGenero()">
            <option value="">Selecione...</option>
            <option value="masculino">Homem</option>
            <option value="feminino">Mulher</option>
            <option value="outro">Outro</option>
          </select>
        </div>
        <div class="form-group" id="editOutroGeneroDiv" style="display: none;">
          <label for="editOutroGenero">Especificar G√™nero</label>
          <input type="text" id="editOutroGenero" placeholder="Digite o g√™nero...">
        </div>
        <div style="display: flex; gap: 15px; margin-top: 15px;">
          <button type="submit" class="btn btn-success">üíæ Salvar</button>
          <button type="button" class="btn" onclick="fecharModal()">‚ùå Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    let pacientes = JSON.parse(localStorage.getItem('pacientes')) || [];
    let examesSelecionados = [];
    let pacienteEditando = null;

    // Formata√ß√£o de campos e busca autom√°tica por CNS
    document.getElementById('cpf').addEventListener('input', function(e) {
      let value = e.target.value.replace(/\D/g, '');
      
      console.log('Digitando CNS:', value, 'Pacientes:', pacientes.length);
      
      // Buscar hist√≥rico se tiver pelo menos 3 d√≠gitos
      if (value.length >= 3) {
        console.log('Buscando hist√≥rico para:', value);
        buscarHistoricoCns(value);
      } else {
        document.getElementById('historicoCns').style.display = 'none';
      }
      
      if (value.length <= 11) {
        // Formato CPF
        value = value.replace(/(\d{3})(\d)/, '$1.$2');
        value = value.replace(/(\d{3})(\d)/, '$1.$2');
        value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
      } else {
        // Formato CNS
        value = value.replace(/(\d{3})(\d{4})(\d{4})(\d{4})/, '$1 $2 $3 $4');
      }
      e.target.value = value;
    });

    document.getElementById('telefone').addEventListener('input', function(e) {
      let value = e.target.value.replace(/\D/g, '');
      value = value.replace(/(\d{2})(\d)/, '($1) $2');
      value = value.replace(/(\d{5})(\d)/, '$1-$2');
      e.target.value = value;
    });

    // Sistema de Toast
    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.innerHTML = `<strong>${type === 'error' ? 'Erro!' : 'Sucesso!'}</strong> ${message}`;
      
      document.getElementById('toastContainer').appendChild(toast);
      
      setTimeout(() => toast.remove(), 4000);
    }
    
    // Buscar hist√≥rico por CNS
    function buscarHistoricoCns(termo) {
      console.log('Fun√ß√£o buscarHistoricoCns chamada com:', termo);
      
      const historicoDiv = document.getElementById('historicoCns');
      if (!historicoDiv) {
        console.log('Elemento historicoCns n√£o encontrado!');
        return;
      }
      
      if (!termo || termo.length < 3) {
        historicoDiv.style.display = 'none';
        return;
      }
      
      const termoBusca = termo.replace(/\D/g, '');
      console.log('Termo de busca limpo:', termoBusca);
      console.log('Total de pacientes:', pacientes.length);
      
      const historico = pacientes.filter(p => {
        if (!p.cpf) return false;
        const cpfLimpo = String(p.cpf).replace(/\D/g, '');
        const match = cpfLimpo.includes(termoBusca) && cpfLimpo !== termoBusca;
        if (match) console.log('Match encontrado:', p.nome, p.cpf);
        return match;
      });
      
      console.log('Hist√≥rico encontrado:', historico.length, 'pacientes');
      
      if (historico.length === 0) {
        historicoDiv.style.display = 'none';
        return;
      }
      
      historicoDiv.innerHTML = historico.map(p => `
        <div class="historico-item" onclick="preencherDadosCns(${p.id})">
          <div class="historico-nome">${p.nome}</div>
          <div class="historico-detalhes">
            CNS/CPF: ${p.cpf} | √öltimo cadastro: ${p.dataCadastro}
          </div>
        </div>
      `).join('');
      
      historicoDiv.style.display = 'block';
      console.log('Dropdown exibido com', historico.length, 'itens');
    }
    
    // Preencher dados do paciente selecionado
    function preencherDadosCns(pacienteId) {
      const paciente = pacientes.find(p => p.id == pacienteId);
      if (!paciente) {
        console.log('Paciente n√£o encontrado:', pacienteId);
        return;
      }
      
      document.getElementById('nome').value = paciente.nome || '';
      document.getElementById('cpf').value = paciente.cpf || '';
      document.getElementById('dataNascimento').value = paciente.dataNascimento || '';
      document.getElementById('telefone').value = paciente.telefone || '';
      document.getElementById('laboratorio').value = paciente.laboratorio || '';
      document.getElementById('endereco').value = paciente.endereco || '';
      
      // Configurar g√™nero
      if (paciente.genero === 'masculino' || paciente.genero === 'feminino') {
        document.getElementById('genero').value = paciente.genero;
        document.getElementById('outroGeneroDiv').style.display = 'none';
      } else if (paciente.genero) {
        document.getElementById('genero').value = 'outro';
        document.getElementById('outroGenero').value = paciente.genero;
        document.getElementById('outroGeneroDiv').style.display = 'block';
      }
      
      // Configurar exames se existirem
      if (paciente.exames && Array.isArray(paciente.exames)) {
        examesSelecionados = [...paciente.exames];
        atualizarExamesVisualizacao();
      }
      
      document.getElementById('historicoCns').style.display = 'none';
      showToast('Dados preenchidos automaticamente', 'info');
    }

    // Lista de exames atualizada
    const examesDisponiveis = {
      'Hematologia': [
        { codigo: 'ABO', nome: 'DETERMINA√á√ÉO DO GRUPO SANGUINIO', valor: 1.37 },
        { codigo: 'COMBI', nome: 'COOMBS INDIRETO', valor: 2.73 },
        { codigo: 'HEMO', nome: 'HEMOGRAMA COMPLETO', valor: 4.11 },
        { codigo: 'RH', nome: 'DETERMINA√á√ÉO DO FATOR RH', valor: 1.37 },
        { codigo: 'VHS', nome: 'VELOCIDADE DE HEMOSSEDIMENTA√á√ÉO', valor: 2.73 }
      ],
      'Bioqu√≠mica': [
        { codigo: 'ACUR', nome: 'ACIDO URICO', valor: 1.85 },
        { codigo: 'BTFA', nome: 'BILIRRUBINAST F', valor: 2.01 },
        { codigo: 'CA', nome: 'CALCIO', valor: 1.85 },
        { codigo: 'COL', nome: 'COLESTEROL TOTAL', valor: 1.85 },
        { codigo: 'CPK', nome: 'CREATINO FOSFOQUINASE (C.P.K.)', valor: 3.68 },
        { codigo: 'CR', nome: 'CREATININA', valor: 1.85 },
        { codigo: 'FAL', nome: 'FOSFATASE ALCALINA', valor: 2.01 },
        { codigo: 'FERRO', nome: 'FERRO SERICO', valor: 3.51 },
        { codigo: 'GGT', nome: 'GAMA GLUTAMINA TRANSFERASE', valor: 3.51 },
        { codigo: 'GLI', nome: 'GLICOSE', valor: 1.85 },
        { codigo: 'GLICO', nome: 'GLICEMIA POS-PRANDIAL', valor: 1.85 },
        { codigo: 'HBGLA', nome: 'HEMOGLOBINA GLICADA (GLICEMIA MEDIA)', valor: 7.86 },
        { codigo: 'HDL', nome: 'HDL-COLESTEROL', valor: 3.51 },
        { codigo: 'IST', nome: 'IST-INDICE DE SATURA√á√ÉO DE TRANSFERRINA', valor: 4.12 },
        { codigo: 'K', nome: 'POTASSIO', valor: 1.85 },
        { codigo: 'LDL', nome: 'LDL-COLESTEROL', valor: 3.51 },
        { codigo: 'NA', nome: 'SODIO', valor: 1.85 },
        { codigo: 'PCR', nome: 'PROTEINA C REATIVA', valor: 2.83 },
        { codigo: 'PTFA', nome: 'PROTEINAS TOTAIS E FRA√áOES', valor: 1.85 },
        { codigo: 'TGO', nome: 'TRANSAMINASE GLUTAMICA OXALACETICA', valor: 2.01 },
        { codigo: 'TGP', nome: 'TRANSAMINASE GLUTAMICA PIRUVICA', valor: 2.01 },
        { codigo: 'TRI', nome: 'TRIGLICERIDES', valor: 3.51 },
        { codigo: 'UREIA', nome: 'UREIA', valor: 1.85 },
        { codigo: 'VLDL', nome: 'VLDL-COLESTEROL', valor: 1.85 }
      ],
      'Endocrinologia': [
        { codigo: 'HCG', nome: 'TESTE DE GRAVIDES', valor: 7.85 },
        { codigo: 'T3A', nome: 'TRIODOTIRONINA-T3 LIVRE', valor: 8.71 },
        { codigo: 'T4LA', nome: 'TIROXINA LIVRE-T4L', valor: 11.6 },
        { codigo: 'TSH', nome: 'HORMONIO TIREOESTIMULANTE', valor: 8.96 }
      ],
      'Sorologia': [
        { codigo: 'ASLO', nome: 'ANTIESTREPTOLISINA-O', valor: 2.83 },
        { codigo: 'CITMG', nome: 'CITOMEGALOVIRUS- ANTICORPOS IGG', valor: 11 },
        { codigo: 'CITMM', nome: 'CITOMEGALOVIRUS- ANTICORPOS IGM', valor: 11.61 },
        { codigo: 'HBSAG', nome: 'HEPATITE B- HBSAG', valor: 18.55 },
        { codigo: 'HCVA', nome: 'HEPATITE C- ANTI HCV', valor: 18.55 },
        { codigo: 'HIV', nome: 'HIV-IMUNOENSAIO 4 GERA√áAO', valor: 10 },
        { codigo: 'LATEX', nome: 'FATOR REUMATOIDE', valor: 2.83 },
        { codigo: 'RUBGA', nome: 'RUBEOLA IGG', valor: 17.16 },
        { codigo: 'RUBMA', nome: 'RUBEOLA IGM', valor: 17.16 },
        { codigo: 'TOXOG', nome: 'TOXOPLASMOSE IGG (ECLIA)', valor: 16.97 },
        { codigo: 'TOXOM', nome: 'TOXOPLASMOSE ANTICORPOS IGM (CMIA)', valor: 18.55 },
        { codigo: 'VDRL', nome: 'VDRL-LUES', valor: 2.83 }
      ],
      'Urina e Fezes': [
        { codigo: 'CCCT', nome: 'ANTIBIOGRAMA + MIC', valor: 13.33 },
        { codigo: 'CULT', nome: 'CULTURA UROCULTURA', valor: 5.62 },
        { codigo: 'FESES', nome: 'PARASITOLOGICO (MIF)', valor: 1.65 },
        { codigo: 'PSO', nome: 'SANGUE OCULTO PESQUISA', valor: 1.65 },
        { codigo: 'URINA', nome: 'URINA JATO MEDIO', valor: 3.7 }
      ],
      'Coagula√ß√£o': [
        { codigo: 'TC', nome: 'TEMPO DE COAGULA√á√ÉO', valor: 2.73 },
        { codigo: 'TP', nome: 'TEMPO DE PROTOMBINA', valor: 2.73 }
      ]
    };

    let examesTemporarios = [];

    // Gerenciamento de exames
    function abrirModalExames() {
      examesTemporarios = [...examesSelecionados];
      carregarExamesModal();
      document.getElementById('modalExames').style.display = 'block';
    }

    function fecharModalExames() {
      document.getElementById('modalExames').style.display = 'none';
    }

    function confirmarExames() {
      examesSelecionados = [...examesTemporarios];
      atualizarExamesVisualizacao();
      fecharModalExames();
    }

    function carregarExamesModal() {
      const grid = document.getElementById('examesModalGrid');
      let html = '';
      
      // Criar lista √∫nica de todos os exames
      const todosExames = [];
      Object.keys(examesDisponiveis).forEach(categoria => {
        examesDisponiveis[categoria].forEach(exame => {
          todosExames.push(exame);
        });
      });
      
      // Ordenar alfabeticamente por c√≥digo
      todosExames.sort((a, b) => a.codigo.localeCompare(b.codigo));
      
      // Dividir em quatro colunas
      const quarto = Math.ceil(todosExames.length / 4);
      const coluna1 = todosExames.slice(0, quarto);
      const coluna2 = todosExames.slice(quarto, quarto * 2);
      const coluna3 = todosExames.slice(quarto * 2, quarto * 3);
      const coluna4 = todosExames.slice(quarto * 3);
      
      // Coluna 1
      html += '<div class="coluna-exames">';
      coluna1.forEach(exame => {
        const selecionado = examesTemporarios.find(e => e.valor === exame.codigo) ? 'selecionado' : '';
        html += `
          <div class="exame-item ${selecionado}" onclick="toggleExameModal('${exame.codigo}', '${exame.nome}')">
            <span class="exame-codigo">${exame.codigo}</span>
            <span class="exame-nome">${exame.nome}</span>
          </div>
        `;
      });
      html += '</div>';
      
      // Coluna 2
      html += '<div class="coluna-exames">';
      coluna2.forEach(exame => {
        const selecionado = examesTemporarios.find(e => e.valor === exame.codigo) ? 'selecionado' : '';
        html += `
          <div class="exame-item ${selecionado}" onclick="toggleExameModal('${exame.codigo}', '${exame.nome}')">
            <span class="exame-codigo">${exame.codigo}</span>
            <span class="exame-nome">${exame.nome}</span>
          </div>
        `;
      });
      html += '</div>';
      
      // Coluna 3
      html += '<div class="coluna-exames">';
      coluna3.forEach(exame => {
        const selecionado = examesTemporarios.find(e => e.valor === exame.codigo) ? 'selecionado' : '';
        html += `
          <div class="exame-item ${selecionado}" onclick="toggleExameModal('${exame.codigo}', '${exame.nome}')">
            <span class="exame-codigo">${exame.codigo}</span>
            <span class="exame-nome">${exame.nome}</span>
          </div>
        `;
      });
      html += '</div>';
      
      // Coluna 4
      html += '<div class="coluna-exames">';
      coluna4.forEach(exame => {
        const selecionado = examesTemporarios.find(e => e.valor === exame.codigo) ? 'selecionado' : '';
        html += `
          <div class="exame-item ${selecionado}" onclick="toggleExameModal('${exame.codigo}', '${exame.nome}')">
            <span class="exame-codigo">${exame.codigo}</span>
            <span class="exame-nome">${exame.nome}</span>
          </div>
        `;
      });
      html += '</div>';
      
      grid.innerHTML = html;
    }



    function toggleExameModal(codigo, nome) {
      const item = event.target.closest('.exame-item');
      const jaExiste = examesTemporarios.find(e => e.valor === codigo);
      
      if (jaExiste) {
        examesTemporarios = examesTemporarios.filter(e => e.valor !== codigo);
        item.classList.remove('selecionado');
      } else {
        examesTemporarios.push({ valor: codigo, texto: `${codigo} - ${nome}` });
        item.classList.add('selecionado');
      }
    }

    function removerExame(valor) {
      examesSelecionados = examesSelecionados.filter(e => e.valor !== valor);
      atualizarExamesVisualizacao();
    }

    function atualizarExamesVisualizacao() {
      const container = document.getElementById('examesSelecionados');
      
      if (examesSelecionados.length === 0) {
        container.innerHTML = '<small style="color: #666;">Nenhum exame selecionado</small>';
        return;
      }
      
      container.innerHTML = examesSelecionados.map(exame => 
        `<span class="exame-tag">${exame.texto} <button type="button" onclick="removerExame('${exame.valor}')" style="background:none;border:none;color:#333;margin-left:5px;cursor:pointer;">√ó</button></span>`
      ).join('');
    }

    // Cadastro/Edi√ß√£o de paciente
    document.getElementById('pacienteForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      if (examesSelecionados.length === 0) {
        showToast('Selecione pelo menos um exame', 'error');
        return;
      }
      
      if (pacienteEditando) {
        // Modo edi√ß√£o
        pacienteEditando.nome = document.getElementById('nome').value;
        pacienteEditando.cpf = document.getElementById('cpf').value;
        pacienteEditando.dataNascimento = document.getElementById('dataNascimento').value;
        pacienteEditando.telefone = document.getElementById('telefone').value;
        pacienteEditando.genero = document.getElementById('genero').value === 'outro' ? document.getElementById('outroGenero').value : document.getElementById('genero').value;
        pacienteEditando.laboratorio = document.getElementById('laboratorio').value;
        pacienteEditando.endereco = document.getElementById('endereco').value;
        pacienteEditando.exames = [...examesSelecionados];
        
        localStorage.setItem('pacientes', JSON.stringify(pacientes));
        criarBackupAutomatico();
        showToast('Paciente atualizado com sucesso');
        
        // Limpar formul√°rio sem mostrar toast
        pacienteEditando = null;
        document.getElementById('pacienteForm').reset();
        examesSelecionados = [];
        atualizarExamesVisualizacao();
        document.getElementById('outroGeneroDiv').style.display = 'none';
        
        // Voltar bot√µes para modo cadastro
        document.getElementById('btnCadastrar').style.display = 'block';
        document.getElementById('botoesEdicao').style.display = 'none';
      } else {
        // Modo cadastro
        const paciente = {
          id: Date.now(),
          nome: document.getElementById('nome').value,
          cpf: document.getElementById('cpf').value,
          dataNascimento: document.getElementById('dataNascimento').value,
          telefone: document.getElementById('telefone').value,
          genero: document.getElementById('genero').value === 'outro' ? document.getElementById('outroGenero').value : document.getElementById('genero').value,
          laboratorio: document.getElementById('laboratorio').value,
          endereco: document.getElementById('endereco').value,
          exames: [...examesSelecionados],
          dataCadastro: new Date().toLocaleDateString('pt-BR')
        };
        
        pacientes.push(paciente);
        localStorage.setItem('pacientes', JSON.stringify(pacientes));
        criarBackupAutomatico();
        showToast('Paciente cadastrado com sucesso');
        
        document.getElementById('pacienteForm').reset();
        examesSelecionados = [];
        atualizarExamesVisualizacao();
      }
      
      atualizarTabela();
      document.getElementById('nome').focus();
    });



    // Busca
    function buscarPacientes() {
      const termo = document.getElementById('busca').value.toLowerCase();
      
      if (!termo.trim()) {
        atualizarTabela(pacientes);
        return;
      }
      
      const pacientesFiltrados = pacientes.filter(p => {
        try {
          const dataNascFormatada = p.dataNascimento ? new Date(p.dataNascimento).toLocaleDateString('pt-BR') : '';
          const examesTexto = p.exames && Array.isArray(p.exames) ? p.exames.map(e => e.texto || '').join(' ').toLowerCase() : '';
          
          return (p.nome && p.nome.toLowerCase().includes(termo)) ||
                 (p.cpf && p.cpf.toLowerCase().includes(termo)) ||
                 (dataNascFormatada && dataNascFormatada.includes(termo)) ||
                 (p.telefone && p.telefone.toLowerCase().includes(termo)) ||
                 (p.genero && p.genero.toLowerCase().includes(termo)) ||
                 (p.laboratorio && p.laboratorio.toLowerCase().includes(termo)) ||
                 (p.endereco && p.endereco.toLowerCase().includes(termo)) ||
                 (examesTexto && examesTexto.includes(termo)) ||
                 (p.dataCadastro && p.dataCadastro.toLowerCase().includes(termo));
        } catch (error) {
          console.error('Erro na busca:', error, p);
          return false;
        }
      });
      
      atualizarTabela(pacientesFiltrados);
    }

    // Fun√ß√µes de formata√ß√£o
    function formatarGenero(genero) {
      if (!genero) return '-';
      const generos = {
        'masculino': 'Masculino',
        'feminino': 'Feminino'
      };
      return generos[genero] || genero;
    }
    
    function formatarLaboratorio(laboratorio) {
      if (!laboratorio) return '-';
      const laboratorios = {
        'apolo': 'Apolo',
        'queiroz': 'Queiroz',
        'sao_lourenco': 'S√£o Louren√ßo'
      };
      return laboratorios[laboratorio] || laboratorio;
    }

    // Tabela
    function atualizarTabela(lista = pacientes) {
      const tbody = document.getElementById('tabelaPacientes');
      
      if (lista.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; color: #666; padding: 30px;">Nenhum paciente encontrado</td></tr>';
        return;
      }
      
      tbody.innerHTML = lista.map(paciente => `
        <tr>
          <td>${paciente.dataCadastro}</td>
          <td>${paciente.nome}</td>
          <td>${paciente.cpf}</td>
          <td>${new Date(paciente.dataNascimento).toLocaleDateString('pt-BR')}</td>
          <td>${paciente.telefone || '-'}</td>
          <td>${formatarGenero(paciente.genero)}</td>
          <td>${formatarLaboratorio(paciente.laboratorio)}</td>
          <td>${paciente.endereco || '-'}</td>
          <td>${paciente.exames.map(e => e.texto).join(', ')}</td>
          <td class="actions">
            <button class="btn btn-small" onclick="editarPaciente(${paciente.id})">‚úèÔ∏è</button>
            <button class="btn btn-small btn-danger" onclick="excluirPaciente(${paciente.id})">üóëÔ∏è</button>
          </td>
        </tr>
      `).join('');
    }

    // Edi√ß√£o
    function editarPaciente(id) {
      pacienteEditando = pacientes.find(p => p.id === id);
      
      // Copiar dados para o formul√°rio principal
      document.getElementById('nome').value = pacienteEditando.nome;
      document.getElementById('cpf').value = pacienteEditando.cpf;
      document.getElementById('dataNascimento').value = pacienteEditando.dataNascimento;
      document.getElementById('telefone').value = pacienteEditando.telefone || '';
      document.getElementById('laboratorio').value = pacienteEditando.laboratorio;
      document.getElementById('endereco').value = pacienteEditando.endereco;
      
      // Configurar g√™nero
      if (pacienteEditando.genero === 'masculino' || pacienteEditando.genero === 'feminino') {
        document.getElementById('genero').value = pacienteEditando.genero;
      } else {
        document.getElementById('genero').value = 'outro';
        document.getElementById('outroGenero').value = pacienteEditando.genero;
        document.getElementById('outroGeneroDiv').style.display = 'block';
      }
      
      // Configurar exames
      examesSelecionados = [...pacienteEditando.exames];
      atualizarExamesVisualizacao();
      
      // Alterar bot√µes para modo edi√ß√£o
      document.getElementById('btnCadastrar').style.display = 'none';
      document.getElementById('botoesEdicao').style.display = 'flex';
      
      // Focar no campo nome
      document.getElementById('nome').focus();
      
      showToast('Dados carregados para edi√ß√£o', 'info');
    }
    
    function cancelarEdicao() {
      pacienteEditando = null;
      document.getElementById('pacienteForm').reset();
      examesSelecionados = [];
      atualizarExamesVisualizacao();
      document.getElementById('outroGeneroDiv').style.display = 'none';
      
      // Voltar bot√µes para modo cadastro
      document.getElementById('btnCadastrar').style.display = 'block';
      document.getElementById('botoesEdicao').style.display = 'none';
      
      document.getElementById('nome').focus();
      showToast('Edi√ß√£o cancelada', 'info');
    }

    document.getElementById('formEdicao').addEventListener('submit', function(e) {
      e.preventDefault();
      
      pacienteEditando.nome = document.getElementById('editNome').value;
      pacienteEditando.telefone = document.getElementById('editTelefone').value;
      pacienteEditando.genero = document.getElementById('editGenero').value === 'outro' ? document.getElementById('editOutroGenero').value : document.getElementById('editGenero').value;
      
      localStorage.setItem('pacientes', JSON.stringify(pacientes));
      showToast('Paciente atualizado com sucesso');
      fecharModal();
      atualizarTabela();
      document.getElementById('nome').focus();
    });

    function fecharModal() {
      document.getElementById('modalEdicao').style.display = 'none';
      pacienteEditando = null;
    }

    // Exclus√£o com prote√ß√£o
    function excluirPaciente(id) {
      const paciente = pacientes.find(p => p.id === id);
      if (!paciente) return;
      
      // Primeira confirma√ß√£o
      if (!confirm(`Tem certeza que deseja excluir o paciente:\n\n${paciente.nome}\nCNS/CPF: ${paciente.cpf}\n\nEsta a√ß√£o n√£o pode ser desfeita!`)) {
        return;
      }
      
      // Segunda confirma√ß√£o com digita√ß√£o do nome
      const nomeDigitado = prompt(`Para confirmar a exclus√£o, digite o nome completo do paciente:\n\n"${paciente.nome}"`);
      
      if (!nomeDigitado) {
        showToast('Exclus√£o cancelada', 'info');
        return;
      }
      
      if (nomeDigitado.trim().toLowerCase() !== paciente.nome.toLowerCase()) {
        showToast('Nome n√£o confere. Exclus√£o cancelada por seguran√ßa.', 'warning');
        return;
      }
      
      // Terceira confirma√ß√£o final
      if (!confirm('√öLTIMA CONFIRMA√á√ÉO:\n\nVoc√™ tem ABSOLUTA CERTEZA que deseja excluir este paciente?\n\nTodos os dados ser√£o perdidos permanentemente!')) {
        showToast('Exclus√£o cancelada', 'info');
        return;
      }
      
      // Executar exclus√£o
      pacientes = pacientes.filter(p => p.id !== id);
      localStorage.setItem('pacientes', JSON.stringify(pacientes));
      criarBackupAutomatico();
      showToast('Paciente exclu√≠do com sucesso', 'success');
      atualizarTabela();
    }

    // Inicializa√ß√£o
    window.addEventListener('load', function() {
      atualizarTabela();
      showToast('Sistema carregado com sucesso!', 'info');
      document.getElementById('nome').focus();
    });

    // Fun√ß√µes para mostrar/ocultar campo "outro g√™nero"
    function toggleOutroGenero() {
      const genero = document.getElementById('genero').value;
      const div = document.getElementById('outroGeneroDiv');
      div.style.display = genero === 'outro' ? 'block' : 'none';
      if (genero !== 'outro') {
        document.getElementById('outroGenero').value = '';
      }
    }

    function toggleEditOutroGenero() {
      const genero = document.getElementById('editGenero').value;
      const div = document.getElementById('editOutroGeneroDiv');
      div.style.display = genero === 'outro' ? 'block' : 'none';
      if (genero !== 'outro') {
        document.getElementById('editOutroGenero').value = '';
      }
    }

    // Fun√ß√µes de Backup
    function criarBackupAutomatico() {
      if (pacientes.length === 0) return;
      
      const dadosExcel = pacientes.map(p => ({
        'Data Cadastro': p.dataCadastro,
        'Nome': p.nome,
        'CNS/CPF': p.cpf,
        'Data Nascimento': new Date(p.dataNascimento).toLocaleDateString('pt-BR'),
        'Telefone': p.telefone || '',
        'G√™nero': formatarGenero(p.genero),
        'Laborat√≥rio': formatarLaboratorio(p.laboratorio),
        'Endere√ßo': p.endereco || '',
        'Exames': p.exames.map(e => e.texto).join(', ')
      }));
      
      const ws = XLSX.utils.json_to_sheet(dadosExcel);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Pacientes');
      
      const wbout = XLSX.write(wb, {bookType:'xlsx', type:'array'});
      const blob = new Blob([wbout], {type: 'application/octet-stream'});
      
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `SCEL_backup_${new Date().toISOString().split('T')[0]}.xlsx`;
      link.click();
    }
    
    function exportarExcel() {
      if (pacientes.length === 0) {
        showToast('Nenhum dado para exportar', 'warning');
        return;
      }
      
      const dadosExcel = pacientes.map(p => ({
        'Data Cadastro': p.dataCadastro,
        'Nome': p.nome,
        'CNS/CPF': p.cpf,
        'Data Nascimento': new Date(p.dataNascimento).toLocaleDateString('pt-BR'),
        'Telefone': p.telefone || '',
        'G√™nero': formatarGenero(p.genero),
        'Laborat√≥rio': formatarLaboratorio(p.laboratorio),
        'Endere√ßo': p.endereco || '',
        'Exames': p.exames.map(e => e.texto).join(', ')
      }));
      
      const ws = XLSX.utils.json_to_sheet(dadosExcel);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Pacientes');
      
      XLSX.writeFile(wb, `SCEL_dados_${new Date().toISOString().split('T')[0]}.xlsx`);
      showToast('Dados exportados para Excel', 'success');
    }
    
    function formatarCNS(cns) {
      if (!cns) return '';
      const numeros = cns.toString().replace(/\D/g, '');
      if (numeros.length === 15) {
        return numeros.replace(/(\d{3})(\d{4})(\d{4})(\d{4})/, '$1 $2 $3 $4');
      }
      return cns;
    }
    
    function processarExames(examesTexto) {
      if (!examesTexto) return [];
      
      return examesTexto.split(',').map(exame => {
        const exameTexto = exame.trim();
        // Gerar c√≥digo baseado no texto do exame
        const codigo = exameTexto.toUpperCase().replace(/[^A-Z0-9]/g, '').substring(0, 10) || 'CUSTOM';
        return {
          valor: codigo,
          texto: exameTexto
        };
      }).filter(e => e.texto);
    }
    
    function importarExcel(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, {type: 'array'});
          const sheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[sheetName];
          const jsonData = XLSX.utils.sheet_to_json(worksheet);
          
          if (jsonData.length > 0 && confirm('Isso ir√° substituir todos os dados atuais. Continuar?')) {
            const pacientesImportados = jsonData.map((row, index) => {
              // Processar data de nascimento
              let dataNasc = '';
              if (row['Data Nascimento']) {
                const data = row['Data Nascimento'];
                if (typeof data === 'number') {
                  // Excel armazena datas como n√∫meros seriais
                  const excelDate = new Date((data - 25569) * 86400 * 1000);
                  dataNasc = excelDate.toISOString().split('T')[0];
                } else if (typeof data === 'string' && data.includes('/')) {
                  const partes = data.split('/');
                  if (partes.length === 3) {
                    dataNasc = `${partes[2]}-${partes[1].padStart(2, '0')}-${partes[0].padStart(2, '0')}`;
                  }
                } else if (data instanceof Date) {
                  dataNasc = data.toISOString().split('T')[0];
                }
              }
              
              // Processar data de cadastro
              let dataCad = new Date().toLocaleDateString('pt-BR');
              if (row['Data Cadastro']) {
                const data = row['Data Cadastro'];
                if (typeof data === 'number') {
                  // Excel armazena datas como n√∫meros seriais
                  const excelDate = new Date((data - 25569) * 86400 * 1000);
                  dataCad = excelDate.toLocaleDateString('pt-BR');
                } else if (typeof data === 'string') {
                  dataCad = data;
                }
              }
              
              return {
                id: Date.now() + index,
                nome: row['Nome'] || '',
                cpf: formatarCNS(row['CNS/CPF']) || '',
                dataNascimento: dataNasc,
                telefone: row['Telefone'] || '',
                genero: row['G√™nero'] === 'Masculino' ? 'masculino' : row['G√™nero'] === 'Feminino' ? 'feminino' : row['G√™nero'] || '',
                laboratorio: row['Laborat√≥rio'] === 'Apolo' ? 'apolo' : row['Laborat√≥rio'] === 'Queiroz' ? 'queiroz' : row['Laborat√≥rio'] === 'S√£o Louren√ßo' ? 'sao_lourenco' : row['Laborat√≥rio'] || '',
                endereco: row['Endere√ßo'] || '',
                exames: processarExames(row['Exames']),
                dataCadastro: dataCad
              };
            });
            
            pacientes = pacientesImportados;
            localStorage.setItem('pacientes', JSON.stringify(pacientes));
            atualizarTabela();
            showToast(`${pacientesImportados.length} pacientes importados do Excel`, 'success');
          }
        } catch (error) {
          console.error('Erro na importa√ß√£o:', error);
          showToast('Erro ao ler arquivo Excel. Verifique o formato.', 'error');
        }
      };
      reader.readAsArrayBuffer(file);
      
      event.target.value = '';
    }

    // Fun√ß√µes do Dashboard
    function abrirEstatisticas() {
      if (pacientes.length === 0) {
        showToast('Nenhum dado para gerar estat√≠sticas', 'warning');
        return;
      }
      
      const stats = calcularEstatisticas();
      const content = document.getElementById('estatisticasContent');
      
      content.innerHTML = `
        <style>
          @keyframes countUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
          @keyframes slideIn { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
          @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
          @keyframes glow { 0%, 100% { box-shadow: 0 0 5px rgba(138, 43, 226, 0.5); } 50% { box-shadow: 0 0 20px rgba(138, 43, 226, 0.8); } }
          .metric-card { animation: countUp 0.6s ease-out; transition: all 0.3s ease; }
          .metric-card:hover { transform: translateY(-5px) scale(1.02); animation: glow 2s infinite; }
          .chart-section { animation: slideIn 0.8s ease-out; background: rgba(255,255,255,0.05) !important; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
          .progress-bar { animation: slideIn 1s ease-out; }
          .dark-card { background: rgba(255,255,255,0.08); backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.2); }
        </style>
        
        <!-- Cards de M√©tricas Principais -->
        <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; margin-bottom: 30px;">
          <div class="metric-card dark-card" style="background: linear-gradient(135deg, #8a2be2 0%, #4b0082 100%); color: white; padding: 25px; border-radius: 15px; text-align: center; box-shadow: 0 10px 30px rgba(138, 43, 226, 0.4); position: relative; overflow: hidden;">
            <div style="position: absolute; top: 10px; left: 15px; font-size: 1.5rem; opacity: 0.7;">üë•</div>
            <div style="font-size: 3rem; font-weight: bold; margin-bottom: 8px; text-shadow: 0 0 10px rgba(255,255,255,0.3);">${stats.total}</div>
            <div style="font-size: 0.9rem; opacity: 0.9; text-transform: uppercase; letter-spacing: 1px;">TOTAL PACIENTES</div>
            <div style="font-size: 0.7rem; opacity: 0.7; margin-top: 8px;">${stats.crescimento > 0 ? '+' + stats.crescimento.toFixed(1) + '% vs anterior' : 'Base inicial'}</div>
          </div>
          
          <div class="metric-card dark-card" style="background: linear-gradient(135deg, #00bfff 0%, #0080ff 100%); color: white; padding: 25px; border-radius: 15px; text-align: center; box-shadow: 0 10px 30px rgba(0, 191, 255, 0.4); position: relative; overflow: hidden;">
            <div style="position: absolute; top: 10px; left: 15px; font-size: 1.5rem; opacity: 0.7;">üìÖ</div>
            <div style="font-size: 3rem; font-weight: bold; margin-bottom: 8px; text-shadow: 0 0 10px rgba(255,255,255,0.3);">${stats.hoje}</div>
            <div style="font-size: 0.9rem; opacity: 0.9; text-transform: uppercase; letter-spacing: 1px;">HOJE</div>
            <div style="font-size: 0.7rem; opacity: 0.7; margin-top: 8px;">Meta: ${Math.ceil(stats.esteMes / new Date().getDate())}/dia</div>
          </div>
          
          <div class="metric-card dark-card" style="background: linear-gradient(135deg, #ff1493 0%, #ff69b4 100%); color: white; padding: 25px; border-radius: 15px; text-align: center; box-shadow: 0 10px 30px rgba(255, 20, 147, 0.4); position: relative; overflow: hidden;">
            <div style="position: absolute; top: 10px; left: 15px; font-size: 1.5rem; opacity: 0.7;">üìà</div>
            <div style="font-size: 3rem; font-weight: bold; margin-bottom: 8px; text-shadow: 0 0 10px rgba(255,255,255,0.3);">${stats.esteMes}</div>
            <div style="font-size: 0.9rem; opacity: 0.9; text-transform: uppercase; letter-spacing: 1px;">ESTE M√äS</div>
            <div style="font-size: 0.7rem; opacity: 0.7; margin-top: 8px;">M√©dia: ${(stats.esteMes / new Date().getDate()).toFixed(1)}/dia</div>
          </div>
          
          <div class="metric-card dark-card" style="background: linear-gradient(135deg, #32cd32 0%, #00ff7f 100%); color: white; padding: 25px; border-radius: 15px; text-align: center; box-shadow: 0 10px 30px rgba(50, 205, 50, 0.4); position: relative; overflow: hidden;">
            <div style="position: absolute; top: 10px; left: 15px; font-size: 1.5rem; opacity: 0.7;">üìû</div>
            <div style="font-size: 3rem; font-weight: bold; margin-bottom: 8px; text-shadow: 0 0 10px rgba(255,255,255,0.3);">${stats.contatos.percentual}%</div>
            <div style="font-size: 0.9rem; opacity: 0.9; text-transform: uppercase; letter-spacing: 1px;">CONTATOS</div>
            <div style="font-size: 0.7rem; opacity: 0.7; margin-top: 8px;">${stats.contatos.percentual >= 80 ? '‚úÖ Excelente' : stats.contatos.percentual >= 60 ? '‚ö†Ô∏è Bom' : '‚ùå Melhorar'}</div>
          </div>
          
          <div class="metric-card dark-card" style="background: linear-gradient(135deg, #ffd700 0%, #ffb347 100%); color: #333; padding: 25px; border-radius: 15px; text-align: center; box-shadow: 0 10px 30px rgba(255, 215, 0, 0.4); position: relative; overflow: hidden;">
            <div style="position: absolute; top: 10px; left: 15px; font-size: 1.5rem; opacity: 0.7;">üí∞</div>
            <div style="font-size: 2.5rem; font-weight: bold; margin-bottom: 8px; text-shadow: 0 0 10px rgba(0,0,0,0.3);">R$ ${stats.financeiro.valorTotal.toFixed(2)}</div>
            <div style="font-size: 0.9rem; opacity: 0.9; text-transform: uppercase; letter-spacing: 1px;">VALOR TOTAL</div>
            <div style="font-size: 0.7rem; opacity: 0.7; margin-top: 8px;">M√©dia: R$ ${stats.financeiro.valorMedioPaciente.toFixed(2)}/pac</div>
          </div>
        </div>
        
        <!-- M√©tricas Financeiras -->
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px;">
          <div class="metric-card dark-card" style="background: linear-gradient(135deg, #20b2aa 0%, #008b8b 100%); color: white; padding: 20px; border-radius: 15px; text-align: center;">
            <div style="font-size: 1.8rem; font-weight: bold; margin-bottom: 5px;">R$ ${stats.financeiro.receitaMensal.toFixed(2)}</div>
            <div style="font-size: 0.8rem; opacity: 0.9; text-transform: uppercase;">RECEITA MENSAL</div>
          </div>
          <div class="metric-card dark-card" style="background: linear-gradient(135deg, #dc143c 0%, #b22222 100%); color: white; padding: 20px; border-radius: 15px; text-align: center;">
            <div style="font-size: 1.5rem; font-weight: bold; margin-bottom: 5px;">R$ ${stats.financeiro.exameMaisCaro.valor.toFixed(2)}</div>
            <div style="font-size: 0.7rem; opacity: 0.9; text-transform: uppercase;">EXAME MAIS CARO</div>
            <div style="font-size: 0.6rem; opacity: 0.7; margin-top: 3px;">${stats.financeiro.exameMaisCaro.nome.substring(0, 20)}...</div>
          </div>
          <div class="metric-card dark-card" style="background: linear-gradient(135deg, #228b22 0%, #006400 100%); color: white; padding: 20px; border-radius: 15px; text-align: center;">
            <div style="font-size: 1.5rem; font-weight: bold; margin-bottom: 5px;">R$ ${stats.financeiro.exameMaisBarato.valor.toFixed(2)}</div>
            <div style="font-size: 0.7rem; opacity: 0.9; text-transform: uppercase;">EXAME MAIS BARATO</div>
            <div style="font-size: 0.6rem; opacity: 0.7; margin-top: 3px;">${stats.financeiro.exameMaisBarato.nome.substring(0, 20)}...</div>
          </div>
          <div class="metric-card dark-card" style="background: linear-gradient(135deg, #9370db 0%, #663399 100%); color: white; padding: 20px; border-radius: 15px; text-align: center;">
            <div style="font-size: 1.5rem; font-weight: bold; margin-bottom: 5px;">R$ ${stats.financeiro.valorMedioPaciente.toFixed(2)}</div>
            <div style="font-size: 0.7rem; opacity: 0.9; text-transform: uppercase;">VALOR M√âDIO/PACIENTE</div>
          </div>
        </div>
        
        <!-- Gr√°fico Principal - Cadastros Mensais -->
        <div class="chart-section dark-card" style="margin-bottom: 20px; padding: 20px; border-radius: 15px;">
          <h3 style="color: white; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px; font-size: 1rem;">üìà CADASTROS MENSAIS</h3>
          <div style="display: flex; align-items: end; justify-content: space-between; height: 80px; margin-bottom: 10px; padding: 0 5px; overflow: hidden;">
            ${stats.cadastrosMensais.map((mes, i) => {
              const maxCount = Math.max(...stats.cadastrosMensais.map(m => m.count));
              const altura = maxCount > 0 ? Math.max((mes.count / maxCount) * 60, 4) : 4;
              return `
              <div style="display: flex; flex-direction: column; align-items: center; flex: 1; min-width: 0;">
                <div style="color: #00bfff; font-size: 0.7rem; font-weight: bold; margin-bottom: 3px;">${mes.count}</div>
                <div style="background: linear-gradient(to top, #00bfff, #8a2be2); width: 16px; border-radius: 8px 8px 0 0; height: ${altura}px; animation: slideIn ${0.3 + i * 0.05}s ease-out;"></div>
                <div style="font-size: 0.6rem; color: rgba(255,255,255,0.7); margin-top: 5px; text-transform: uppercase;">${mes.mes}</div>
              </div>
            `}).join('')}
          </div>
        </div>
        
        <!-- Se√ß√£o Principal de An√°lises -->
        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 20px;">
          <!-- Coluna Esquerda - Gr√°ficos Principais -->
          <div style="display: grid; grid-template-rows: 1fr 1fr; gap: 20px;">
            <!-- Distribui√ß√£o por G√™nero e Laborat√≥rios -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
              <!-- G√™nero -->
              <div class="chart-section dark-card" style="padding: 20px; border-radius: 15px;">
                <h3 style="color: white; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px; font-size: 0.9rem;">
                  üë• DISTRIBUI√á√ÉO G√äNERO
                </h3>
                <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 15px;">
                  <div style="width: 80px; height: 80px; border-radius: 50%; background: conic-gradient(#8a2be2 0deg ${stats.genero.masculinoPerc * 3.6}deg, #ff1493 ${stats.genero.masculinoPerc * 3.6}deg ${(stats.genero.masculinoPerc + stats.genero.femininoPerc) * 3.6}deg, #32cd32 ${(stats.genero.masculinoPerc + stats.genero.femininoPerc) * 3.6}deg 360deg); position: relative; box-shadow: 0 0 15px rgba(138, 43, 226, 0.4);">
                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 40px; height: 40px; background: rgba(0,0,0,0.8); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: bold; color: white;">${stats.total}</div>
                  </div>
                </div>
                <div style="font-size: 0.7rem; color: rgba(255,255,255,0.9);">
                  <div style="display: flex; align-items: center; margin-bottom: 4px;"><div style="width: 8px; height: 8px; background: #8a2be2; border-radius: 50%; margin-right: 6px;"></div>Masculino: ${stats.genero.masculino}</div>
                  <div style="display: flex; align-items: center; margin-bottom: 4px;"><div style="width: 8px; height: 8px; background: #ff1493; border-radius: 50%; margin-right: 6px;"></div>Feminino: ${stats.genero.feminino}</div>
                  ${stats.genero.outros > 0 ? `<div style="display: flex; align-items: center;"><div style="width: 8px; height: 8px; background: #32cd32; border-radius: 50%; margin-right: 6px;"></div>Outros: ${stats.genero.outros}</div>` : ''}
                </div>
              </div>
          
              <!-- Laborat√≥rios - Financeiro -->
              <div class="chart-section dark-card" style="padding: 20px; border-radius: 15px;">
                <h3 style="color: white; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px; font-size: 0.9rem;">
                  üè• RECEITA POR LABORAT√ìRIO
                </h3>
                <div style="margin-bottom: 10px;">
                  <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                    <span style="font-size: 0.75rem; color: rgba(255,255,255,0.9);">Apolo</span><span style="font-weight: bold; color: #8a2be2; font-size: 0.8rem;">R$ ${stats.financeiro.laboratorioValores.apolo.toFixed(2)}</span>
                  </div>
                  <div style="background: rgba(255,255,255,0.1); border-radius: 8px; height: 6px; overflow: hidden;">
                    <div class="progress-bar" style="background: linear-gradient(90deg, #8a2be2, #4b0082); height: 100%; border-radius: 8px; width: ${Math.round((stats.financeiro.laboratorioValores.apolo / stats.financeiro.valorTotal) * 100)}%; transition: width 1.5s ease-out;"></div>
                  </div>
                </div>
                <div style="margin-bottom: 10px;">
                  <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                    <span style="font-size: 0.75rem; color: rgba(255,255,255,0.9);">Queiroz</span><span style="font-weight: bold; color: #ff1493; font-size: 0.8rem;">R$ ${stats.financeiro.laboratorioValores.queiroz.toFixed(2)}</span>
                  </div>
                  <div style="background: rgba(255,255,255,0.1); border-radius: 8px; height: 6px; overflow: hidden;">
                    <div class="progress-bar" style="background: linear-gradient(90deg, #ff1493, #ff69b4); height: 100%; border-radius: 8px; width: ${Math.round((stats.financeiro.laboratorioValores.queiroz / stats.financeiro.valorTotal) * 100)}%; transition: width 1.5s ease-out 0.3s;"></div>
                  </div>
                </div>
                <div>
                  <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                    <span style="font-size: 0.75rem; color: rgba(255,255,255,0.9);">S√£o Louren√ßo</span><span style="font-weight: bold; color: #00bfff; font-size: 0.8rem;">R$ ${stats.financeiro.laboratorioValores.saoLourenco.toFixed(2)}</span>
                  </div>
                  <div style="background: rgba(255,255,255,0.1); border-radius: 8px; height: 6px; overflow: hidden;">
                    <div class="progress-bar" style="background: linear-gradient(90deg, #00bfff, #0080ff); height: 100%; border-radius: 8px; width: ${Math.round((stats.financeiro.laboratorioValores.saoLourenco / stats.financeiro.valorTotal) * 100)}%; transition: width 1.5s ease-out 0.6s;"></div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Faixa Et√°ria -->
            <div class="chart-section dark-card" style="padding: 20px; border-radius: 15px;">
              <h3 style="color: white; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px; font-size: 0.9rem;">
                üë∂üë®üë¥ FAIXA ET√ÅRIA
              </h3>
              <div style="display: flex; justify-content: space-around; text-align: center;">
                <div style="flex: 1; padding: 12px; background: rgba(138, 43, 226, 0.15); border-radius: 8px; margin: 0 3px;">
                  <div style="font-size: 1.8rem; font-weight: bold; color: #8a2be2; text-shadow: 0 0 8px rgba(138, 43, 226, 0.4);">${stats.idade.criancas}</div>
                  <div style="font-size: 0.7rem; color: rgba(255,255,255,0.8); text-transform: uppercase;">0-18 anos</div>
                </div>
                <div style="flex: 1; padding: 12px; background: rgba(255, 20, 147, 0.15); border-radius: 8px; margin: 0 3px;">
                  <div style="font-size: 1.8rem; font-weight: bold; color: #ff1493; text-shadow: 0 0 8px rgba(255, 20, 147, 0.4);">${stats.idade.adultos}</div>
                  <div style="font-size: 0.7rem; color: rgba(255,255,255,0.8); text-transform: uppercase;">19-59 anos</div>
                </div>
                <div style="flex: 1; padding: 12px; background: rgba(50, 205, 50, 0.15); border-radius: 8px; margin: 0 3px;">
                  <div style="font-size: 1.8rem; font-weight: bold; color: #32cd32; text-shadow: 0 0 8px rgba(50, 205, 50, 0.4);">${stats.idade.idosos}</div>
                  <div style="font-size: 0.7rem; color: rgba(255,255,255,0.8); text-transform: uppercase;">60+ anos</div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Coluna Direita - Top Exames -->
          <div class="chart-section dark-card" style="padding: 20px; border-radius: 15px;">
            <h3 style="color: white; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px; font-size: 0.9rem;">
              üß™ TOP 15 EXAMES SOLICITADOS
            </h3>
            <div style="max-height: 400px; overflow-y: auto; padding-right: 5px;">
            ${stats.examesMaisSolicitados.map((e, i) => {
              const cores = ['#8a2be2', '#ff1493', '#32cd32', '#00bfff', '#ff69b4', '#ffa500', '#ff6347', '#40e0d0', '#da70d6', '#98fb98', '#f0e68c', '#dda0dd', '#87ceeb', '#f4a460', '#cd853f'];
              const cor = cores[i % cores.length];
              return `
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 10px; margin-bottom: 6px; background: rgba(255,255,255,0.05); border-radius: 6px; border-left: 3px solid ${cor};">
                <div style="display: flex; align-items: center;">
                  <span style="background: ${cor}; color: white; width: 16px; height: 16px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.6rem; margin-right: 8px; font-weight: bold;">${i + 1}</span>
                  <span style="font-size: 0.75rem; color: rgba(255,255,255,0.9);">${e.nome}</span>
                </div>
                <span style="font-weight: bold; color: white; font-size: 0.8rem;">${e.count}x</span>
              </div>
            `}).join('')}
            </div>
          </div>
        </div>
        
        <!-- Se√ß√£o de Qualidade dos Dados -->
        <div class="chart-section dark-card" style="padding: 20px; border-radius: 15px; margin-top: 20px;">
          <h3 style="color: white; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px; font-size: 0.9rem;">
            üìä QUALIDADE DOS DADOS DE CONTATO
          </h3>
          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; text-align: center;">
            <div style="padding: 15px; background: rgba(50, 205, 50, 0.15); border-radius: 10px;">
              <div style="font-size: 1.8rem; font-weight: bold; color: #32cd32; margin-bottom: 5px;">${stats.contatos.comTelefone}</div>
              <div style="font-size: 0.7rem; color: rgba(255,255,255,0.8); text-transform: uppercase;">Com Telefone</div>
            </div>
            <div style="padding: 15px; background: rgba(255, 107, 107, 0.15); border-radius: 10px;">
              <div style="font-size: 1.8rem; font-weight: bold; color: #ff6b6b; margin-bottom: 5px;">${stats.contatos.semTelefone}</div>
              <div style="font-size: 0.7rem; color: rgba(255,255,255,0.8); text-transform: uppercase;">Sem Telefone</div>
            </div>
            <div style="padding: 15px; background: rgba(255,255,255,0.05); border-radius: 10px;">
              <div style="font-size: 1.8rem; font-weight: bold; color: ${stats.contatos.percentual >= 80 ? '#32cd32' : stats.contatos.percentual >= 60 ? '#ffa500' : '#ff6b6b'}; margin-bottom: 5px;">${stats.contatos.percentual}%</div>
              <div style="font-size: 0.7rem; color: rgba(255,255,255,0.8); text-transform: uppercase;">Taxa Qualidade</div>
            </div>
          </div>
        </div>
        
        <!-- An√°lises Financeiras Detalhadas -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
          <!-- Valores por Categoria -->
          <div class="chart-section dark-card" style="padding: 20px; border-radius: 15px;">
            <h3 style="color: white; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px; font-size: 0.9rem;">
              üíä RECEITA POR CATEGORIA
            </h3>
            <div style="max-height: 200px; overflow-y: auto;">
            ${Object.entries(stats.financeiro.categoriaValores).map(([categoria, valor]) => `
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                <span style="font-size: 0.8rem; color: rgba(255,255,255,0.9);">${categoria}</span>
                <span style="font-weight: bold; color: #ffd700; font-size: 0.9rem;">R$ ${valor.toFixed(2)}</span>
              </div>
            `).join('')}
            </div>
          </div>
          
          <!-- Top Exames por Valor -->
          <div class="chart-section dark-card" style="padding: 20px; border-radius: 15px;">
            <h3 style="color: white; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px; font-size: 0.9rem;">
              üíé TOP 5 EXAMES MAIS CAROS
            </h3>
            <div>
            ${stats.financeiro.topExamesCaros.map((e, i) => `
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                <div style="display: flex; align-items: center;">
                  <span style="background: #dc143c; color: white; width: 16px; height: 16px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.6rem; margin-right: 8px; font-weight: bold;">${i + 1}</span>
                  <span style="font-size: 0.7rem; color: rgba(255,255,255,0.9);">${e.nome.substring(0, 25)}...</span>
                </div>
                <span style="font-weight: bold; color: #dc143c; font-size: 0.8rem;">R$ ${e.valor.toFixed(2)}</span>
              </div>
            `).join('')}
            </div>
          </div>
        </div>
      `;
      
      document.getElementById('modalEstatisticas').style.display = 'block';
    }
    
    function calcularEstatisticas() {
      const hoje = new Date().toLocaleDateString('pt-BR');
      const mesAtual = new Date().getMonth();
      const anoAtual = new Date().getFullYear();
      
      const stats = {
        total: pacientes.length,
        hoje: pacientes.filter(p => p.dataCadastro === hoje).length,
        esteMes: pacientes.filter(p => {
          const data = new Date(p.dataCadastro.split('/').reverse().join('-'));
          return data.getMonth() === mesAtual && data.getFullYear() === anoAtual;
        }).length,
        genero: { masculino: 0, feminino: 0, outros: 0 },
        laboratorio: { apolo: 0, queiroz: 0, saoLourenco: 0 },
        idade: { criancas: 0, adultos: 0, idosos: 0 },
        contatos: { comTelefone: 0, semTelefone: 0 },
        examesMaisSolicitados: [],
        idadeMedia: 0,
        perfilIdade: '',
        crescimento: 0,
        ultimosSete: [],
        tendencia: 0,
        cadastrosMensais: [],
        financeiro: {
          valorTotal: 0,
          receitaMensal: 0,
          valorMedioPaciente: 0,
          exameMaisCaro: { nome: '', valor: 0 },
          exameMaisBarato: { nome: '', valor: 999 },
          laboratorioValores: { apolo: 0, queiroz: 0, saoLourenco: 0 },
          categoriaValores: {},
          topExamesCaros: [],
          topExamesBaratos: []
        }
      };
      
      const examesCount = {};
      const categoriaValores = {};
      let valorTotalGeral = 0;
      let valorMesAtual = 0;
      let exameMaisCaro = { nome: '', valor: 0 };
      let exameMaisBarato = { nome: '', valor: 999 };
      const examesValores = [];
      
      pacientes.forEach(p => {
        // G√™nero
        if (p.genero === 'masculino') stats.genero.masculino++;
        else if (p.genero === 'feminino') stats.genero.feminino++;
        else stats.genero.outros++;
        
        // Laborat√≥rio
        if (p.laboratorio === 'apolo') stats.laboratorio.apolo++;
        else if (p.laboratorio === 'queiroz') stats.laboratorio.queiroz++;
        else if (p.laboratorio === 'sao_lourenco') stats.laboratorio.saoLourenco++;
        
        // Idade
        if (p.dataNascimento) {
          const idade = new Date().getFullYear() - new Date(p.dataNascimento).getFullYear();
          if (idade <= 18) stats.idade.criancas++;
          else if (idade <= 59) stats.idade.adultos++;
          else stats.idade.idosos++;
        }
        
        // Contatos
        if (p.telefone && p.telefone.trim()) stats.contatos.comTelefone++;
        else stats.contatos.semTelefone++;
        
        // Exames e c√°lculos financeiros
        let valorPaciente = 0;
        if (p.exames && Array.isArray(p.exames)) {
          p.exames.forEach(exame => {
            examesCount[exame.texto] = (examesCount[exame.texto] || 0) + 1;
            
            // Buscar valor do exame
            let valorExame = 0;
            let categoriaExame = '';
            Object.keys(examesDisponiveis).forEach(categoria => {
              const exameEncontrado = examesDisponiveis[categoria].find(e => 
                exame.texto.includes(e.codigo) || exame.valor === e.codigo
              );
              if (exameEncontrado) {
                valorExame = exameEncontrado.valor;
                categoriaExame = categoria;
              }
            });
            
            valorPaciente += valorExame;
            valorTotalGeral += valorExame;
            
            // Verificar se √© do m√™s atual
            const dataPaciente = new Date(p.dataCadastro.split('/').reverse().join('-'));
            if (dataPaciente.getMonth() === mesAtual && dataPaciente.getFullYear() === anoAtual) {
              valorMesAtual += valorExame;
            }
            
            // Atualizar valores por categoria
            if (categoriaExame) {
              categoriaValores[categoriaExame] = (categoriaValores[categoriaExame] || 0) + valorExame;
            }
            
            // Atualizar valores por laborat√≥rio
            if (valorExame > 0) {
              if (p.laboratorio === 'apolo') stats.financeiro.laboratorioValores.apolo += valorExame;
              else if (p.laboratorio === 'queiroz') stats.financeiro.laboratorioValores.queiroz += valorExame;
              else if (p.laboratorio === 'sao_lourenco') stats.financeiro.laboratorioValores.saoLourenco += valorExame;
            }
            
            // Verificar exame mais caro e mais barato
            if (valorExame > 0) {
              examesValores.push({ nome: exame.texto, valor: valorExame });
              if (valorExame > exameMaisCaro.valor) {
                exameMaisCaro = { nome: exame.texto, valor: valorExame };
              }
              if (valorExame < exameMaisBarato.valor) {
                exameMaisBarato = { nome: exame.texto, valor: valorExame };
              }
            }
          });
        }
      });
      
      // Percentuais de g√™nero
      stats.genero.masculinoPerc = Math.round((stats.genero.masculino / stats.total) * 100);
      stats.genero.femininoPerc = Math.round((stats.genero.feminino / stats.total) * 100);
      
      // Percentual de contatos
      stats.contatos.percentual = Math.round((stats.contatos.comTelefone / stats.total) * 100);
      
      // Top 15 exames
      stats.examesMaisSolicitados = Object.entries(examesCount)
        .sort(([,a], [,b]) => b - a)
        .slice(0, 15)
        .map(([nome, count]) => ({ nome, count }));
      
      // Finalizar c√°lculos financeiros
      stats.financeiro.valorTotal = valorTotalGeral;
      stats.financeiro.receitaMensal = valorMesAtual;
      stats.financeiro.valorMedioPaciente = stats.total > 0 ? valorTotalGeral / stats.total : 0;
      stats.financeiro.exameMaisCaro = exameMaisCaro.valor > 0 ? exameMaisCaro : { nome: 'N/A', valor: 0 };
      stats.financeiro.exameMaisBarato = exameMaisBarato.valor < 999 ? exameMaisBarato : { nome: 'N/A', valor: 0 };
      stats.financeiro.categoriaValores = categoriaValores;
      
      // Top 5 exames mais caros e mais baratos
      const examesOrdenados = examesValores.sort((a, b) => b.valor - a.valor);
      stats.financeiro.topExamesCaros = examesOrdenados.slice(0, 5);
      stats.financeiro.topExamesBaratos = examesOrdenados.slice(-5).reverse();
      
      // Idade m√©dia e perfil
      let somaIdades = 0;
      let countIdades = 0;
      pacientes.forEach(p => {
        if (p.dataNascimento) {
          const idade = new Date().getFullYear() - new Date(p.dataNascimento).getFullYear();
          somaIdades += idade;
          countIdades++;
        }
      });
      stats.idadeMedia = countIdades > 0 ? Math.round(somaIdades / countIdades) : 0;
      stats.perfilIdade = stats.idadeMedia <= 25 ? 'Jovem' : stats.idadeMedia <= 45 ? 'Adulto' : stats.idadeMedia <= 65 ? 'Maduro' : 'S√™nior';
      
      // √öltimos 7 dias
      const ultimosSete = [];
      for (let i = 6; i >= 0; i--) {
        const data = new Date();
        data.setDate(data.getDate() - i);
        const dataStr = data.toLocaleDateString('pt-BR');
        const count = pacientes.filter(p => p.dataCadastro === dataStr).length;
        ultimosSete.push({
          dia: data.toLocaleDateString('pt-BR', { weekday: 'short' }),
          count: count
        });
      }
      stats.ultimosSete = ultimosSete;
      
      // Tend√™ncia (compara√ß√£o √∫ltimos 3 dias vs 3 anteriores)
      const ultimos3 = ultimosSete.slice(-3).reduce((sum, dia) => sum + dia.count, 0);
      const anteriores3 = ultimosSete.slice(-6, -3).reduce((sum, dia) => sum + dia.count, 0);
      stats.tendencia = anteriores3 > 0 ? ((ultimos3 - anteriores3) / anteriores3) * 100 : 0;
      
      // Cadastros mensais (√∫ltimos 12 meses)
      const meses = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
      const cadastrosMensais = [];
      
      // Debug: verificar datas dos pacientes
      console.log('Datas de cadastro dos pacientes:', pacientes.map(p => p.dataCadastro));
      
      for (let i = 11; i >= 0; i--) {
        const dataReferencia = new Date();
        dataReferencia.setMonth(dataReferencia.getMonth() - i);
        const mesReferencia = dataReferencia.getMonth();
        const anoReferencia = dataReferencia.getFullYear();
        
        console.log(`Verificando m√™s: ${meses[mesReferencia]}/${anoReferencia}`);
        
        const count = pacientes.filter(p => {
          if (!p.dataCadastro) return false;
          try {
            // Tratar formato brasileiro dd/mm/aaaa
            const partes = p.dataCadastro.split('/');
            if (partes.length === 3) {
              const dia = parseInt(partes[0]);
              const mes = parseInt(partes[1]) - 1; // JavaScript usa 0-11 para meses
              const ano = parseInt(partes[2]);
              
              const dataPaciente = new Date(ano, mes, dia);
              const mesMatch = dataPaciente.getMonth() === mesReferencia;
              const anoMatch = dataPaciente.getFullYear() === anoReferencia;
              
              if (mesMatch && anoMatch) {
                console.log(`Paciente encontrado: ${p.nome} - ${p.dataCadastro}`);
              }
              
              return mesMatch && anoMatch;
            }
            return false;
          } catch (error) {
            console.error('Erro ao processar data:', p.dataCadastro, error);
            return false;
          }
        }).length;
        
        console.log(`${meses[mesReferencia]}: ${count} cadastros`);
        
        cadastrosMensais.push({
          mes: meses[mesReferencia],
          count: count
        });
      }
      stats.cadastrosMensais = cadastrosMensais;
      
      console.log('Cadastros mensais final:', cadastrosMensais);
      
      // Crescimento mensal (compara√ß√£o com m√™s anterior)
      const mesAtualCount = cadastrosMensais[cadastrosMensais.length - 1]?.count || 0;
      const mesAnteriorCount = cadastrosMensais[cadastrosMensais.length - 2]?.count || 0;
      stats.crescimento = mesAnteriorCount > 0 ? ((mesAtualCount - mesAnteriorCount) / mesAnteriorCount) * 100 : 0;
      
      return stats;
    }
    
    function fecharEstatisticas() {
      document.getElementById('modalEstatisticas').style.display = 'none';
    }
    
    function imprimirDashboard() {
      // Criar uma nova janela para impress√£o
      const printWindow = window.open('', '_blank');
      const stats = calcularEstatisticas();
      
      const printContent = `
        <!DOCTYPE html>
        <html>
        <head>
          <title>Dashboard SCEL - ${new Date().toLocaleDateString('pt-BR')}</title>
          <style>
            * { margin: 0; padding: 0; box-sizing: border-box; }
            body { font-family: Arial, sans-serif; font-size: 9px; line-height: 1.2; padding: 10px; }
            h1 { text-align: center; margin-bottom: 12px; font-size: 14px; }
            h2 { font-size: 10px; margin-bottom: 6px; border-bottom: 1px solid #333; padding-bottom: 2px; }
            .grid { display: grid; gap: 8px; margin-bottom: 12px; }
            .grid-5 { grid-template-columns: 1fr 1fr 1fr 1fr 1fr; }
            .grid-4 { grid-template-columns: 1fr 1fr 1fr 1fr; }
            .grid-3 { grid-template-columns: 1fr 1fr 1fr; }
            .grid-2 { grid-template-columns: 1fr 1fr; }
            .card { border: 1px solid #333; padding: 6px; text-align: center; background: #f8f9fa; }
            .metric { font-size: 14px; font-weight: bold; margin-bottom: 2px; }
            .label { font-size: 7px; text-transform: uppercase; }
            .chart-container { border: 1px solid #ddd; padding: 6px; margin-bottom: 8px; }
            .exame-list { font-size: 7px; line-height: 1.2; }
            .exame-item { display: flex; justify-content: space-between; padding: 1px 0; border-bottom: 1px dotted #ccc; }
            .bar-chart { display: flex; align-items: end; height: 25px; gap: 1px; margin: 3px 0; overflow: hidden; }
            .bar { background: #333; width: 8px; margin: 0 1px; max-height: 20px; }
            .bar-label { font-size: 6px; text-align: center; margin-top: 1px; }
            .bar-container { display: flex; flex-direction: column; align-items: center; flex: 1; }
            .financial { background: #fff3cd; border: 1px solid #ffeaa7; }
          </style>
        </head>
        <body>
          <h1>üè• DASHBOARD ACOMPANHAMENTO SCEL - ${new Date().toLocaleDateString('pt-BR')}</h1>
          
          <!-- M√©tricas Principais -->
          <div class="grid grid-5">
            <div class="card">
              <div class="metric">${stats.total}</div>
              <div class="label">Total Pacientes</div>
            </div>
            <div class="card">
              <div class="metric">${stats.hoje}</div>
              <div class="label">Hoje</div>
            </div>
            <div class="card">
              <div class="metric">${stats.esteMes}</div>
              <div class="label">Este M√™s</div>
            </div>
            <div class="card">
              <div class="metric">${stats.contatos.percentual}%</div>
              <div class="label">Taxa Contato</div>
            </div>
            <div class="card financial">
              <div class="metric">R$ ${stats.financeiro.valorTotal.toFixed(2)}</div>
              <div class="label">Valor Total</div>
            </div>
          </div>
          
          <!-- M√©tricas Financeiras -->
          <div class="grid grid-4">
            <div class="card financial">
              <div class="metric">R$ ${stats.financeiro.receitaMensal.toFixed(2)}</div>
              <div class="label">Receita Mensal</div>
            </div>
            <div class="card financial">
              <div class="metric">R$ ${stats.financeiro.valorMedioPaciente.toFixed(2)}</div>
              <div class="label">M√©dia/Paciente</div>
            </div>
            <div class="card financial">
              <div class="metric">R$ ${stats.financeiro.exameMaisCaro.valor.toFixed(2)}</div>
              <div class="label">Exame Mais Caro</div>
            </div>
            <div class="card financial">
              <div class="metric">R$ ${stats.financeiro.exameMaisBarato.valor.toFixed(2)}</div>
              <div class="label">Exame Mais Barato</div>
            </div>
          </div>
          
          <!-- Cadastros Mensais -->
          <div class="chart-container">
            <h2>Cadastros Mensais</h2>
            <div class="bar-chart">
              ${(() => {
                const maxCount = Math.max(...stats.cadastrosMensais.map(m => m.count), 1);
                return stats.cadastrosMensais.map(m => {
                  const altura = Math.max((m.count / maxCount) * 25, 2);
                  return `
                    <div class="bar-container">
                      <div class="bar" style="height: ${altura}px;"></div>
                      <div class="bar-label">${m.mes}</div>
                      <div class="bar-label">${m.count}</div>
                    </div>
                  `;
                }).join('');
              })()}
            </div>
          </div>
          
          <!-- An√°lises -->
          <div class="grid grid-3">
            <div class="chart-container">
              <h2>Por G√™nero</h2>
              <div>Masculino: ${stats.genero.masculino} (${stats.genero.masculinoPerc}%)</div>
              <div>Feminino: ${stats.genero.feminino} (${stats.genero.femininoPerc}%)</div>
              ${stats.genero.outros > 0 ? `<div>Outros: ${stats.genero.outros}</div>` : ''}
            </div>
            
            <div class="chart-container financial">
              <h2>Receita por Laborat√≥rio</h2>
              <div>Apolo: R$ ${stats.financeiro.laboratorioValores.apolo.toFixed(2)}</div>
              <div>Queiroz: R$ ${stats.financeiro.laboratorioValores.queiroz.toFixed(2)}</div>
              <div>S√£o Louren√ßo: R$ ${stats.financeiro.laboratorioValores.saoLourenco.toFixed(2)}</div>
            </div>
            
            <div class="chart-container">
              <h2>Faixa Et√°ria</h2>
              <div>0-18 anos: ${stats.idade.criancas}</div>
              <div>19-59 anos: ${stats.idade.adultos}</div>
              <div>60+ anos: ${stats.idade.idosos}</div>
            </div>
          </div>
          
          <!-- An√°lises Detalhadas -->
          <div class="grid grid-2">
            <div class="chart-container">
              <h2>Top 10 Exames Mais Solicitados</h2>
              <div class="exame-list">
                ${stats.examesMaisSolicitados.slice(0, 10).map((e, i) => `
                  <div class="exame-item">
                    <span>${i + 1}. ${e.nome.substring(0, 30)}...</span>
                    <span>${e.count}x</span>
                  </div>
                `).join('')}
              </div>
            </div>
            
            <div class="chart-container financial">
              <h2>Receita por Categoria</h2>
              <div class="exame-list">
                ${Object.entries(stats.financeiro.categoriaValores).map(([categoria, valor]) => `
                  <div class="exame-item">
                    <span>${categoria}</span>
                    <span>R$ ${valor.toFixed(2)}</span>
                  </div>
                `).join('')}
              </div>
            </div>
          </div>
          
          <!-- Top Exames por Valor -->
          <div class="chart-container financial">
            <h2>Top 5 Exames Mais Caros</h2>
            <div class="exame-list">
              ${stats.financeiro.topExamesCaros.map((e, i) => `
                <div class="exame-item">
                  <span>${i + 1}. ${e.nome.substring(0, 40)}...</span>
                  <span>R$ ${e.valor.toFixed(2)}</span>
                </div>
              `).join('')}
            </div>
          </div>
          
          <!-- Resumo Final -->
          <div class="grid grid-4">
            <div class="card">
              <div class="metric">${stats.contatos.comTelefone}</div>
              <div class="label">Com Telefone</div>
            </div>
            <div class="card">
              <div class="metric">${stats.contatos.semTelefone}</div>
              <div class="label">Sem Telefone</div>
            </div>
            <div class="card">
              <div class="metric">${stats.contatos.percentual}%</div>
              <div class="label">Taxa Qualidade</div>
            </div>
            <div class="card financial">
              <div class="metric">${stats.crescimento.toFixed(1)}%</div>
              <div class="label">Crescimento</div>
            </div>
          </div>
          
          <div style="text-align: center; margin-top: 20px; font-size: 8px; color: #666;">
            Gerado em: ${new Date().toLocaleString('pt-BR')} | Sistema SCEL
          </div>
        </body>
        </html>
      `;
      
      printWindow.document.write(printContent);
      printWindow.document.close();
      
      // Aguardar carregamento e imprimir
      printWindow.onload = function() {
        setTimeout(() => {
          printWindow.print();
          printWindow.close();
        }, 500);
      };
    }

    // Fechar modal e hist√≥rico clicando fora
    window.onclick = function(event) {
      const modalEdicao = document.getElementById('modalEdicao');
      const modalEstatisticas = document.getElementById('modalEstatisticas');
      const historicoCns = document.getElementById('historicoCns');
      
      if (event.target === modalEdicao) {
        fecharModal();
      } else if (event.target === modalEstatisticas) {
        fecharEstatisticas();
      } else if (!event.target.closest('#cpf') && !event.target.closest('#historicoCns')) {
        historicoCns.style.display = 'none';
      }
    }
  </script>
</body>
</html>